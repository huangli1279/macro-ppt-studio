name: Build and Test Docker Image

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: hongguanai4:test
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
      
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Run container for testing
        run: |
          docker run -d \
            --name hongguanai4-test \
            -p 3000:3000 \
            -e DATABASE_TYPE=sqlite \
            -e SQLITE_DB_PATH=/app/data/test.db \
            hongguanai4:test
          
          # Wait for container to be ready
          sleep 10
      
      - name: Test health endpoint
        run: |
          curl -f http://localhost:3000/api/health || exit 1
      
      - name: Stop test container
        if: always()
        run: |
          docker stop hongguanai4-test || true
          docker rm hongguanai4-test || true
      
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-logs
          path: /tmp/docker-build.log

  # 可选：推送到容器镜像仓库
  push:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 根据实际使用的镜像仓库配置登录
      # 示例：Docker Hub
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # 示例：腾讯云容器镜像服务
      # - name: Login to Tencent Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ccr.ccs.tencentyun.com
      #     username: ${{ secrets.TENCENT_REGISTRY_USERNAME }}
      #     password: ${{ secrets.TENCENT_REGISTRY_PASSWORD }}
      
      # 示例：阿里云容器镜像服务
      # - name: Login to Aliyun Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: registry.cn-hangzhou.aliyuncs.com
      #     username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
      #     password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
      
      # - name: Build and push
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     push: true
      #     tags: |
      #       your-registry/hongguanai4:latest
      #       your-registry/hongguanai4:${{ github.sha }}

